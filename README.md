# APTSniffer
## Introduction:

This is a project related to APT traffic detection.

## Abstract:

Advanced Persistent Threats (APT) differ from traditional attacks like DDoS or webshells. They employ more complex and covert infiltration strategies to execute long-term assaults on target systems, posing a severe threat to organizational and national security. Identifying complex APT activities without relying on known Indicator of Compromise (IOC) clues has proven challenging. Due to problems like the shortage of APT traffic data and encrypted traffic obfuscation, existing methods cannot accurately identify APT traffic with just a few attack traffic samples.

To overcome the above limitation, we propose a novel encrypted APT traffic detection model, APTSniffer, which combines large language models (LLM) and retrieval-augmented technology. Our model first extracts features from the predicted traffic samples. Then, it uses retrieval-augmented technology to identify few-shot traffic information with similar behavior patterns and attack habits in historical traffic samples. Finally, the retrieved sample information and the auxiliary fine-tuning weight matrix, which has prior knowledge from the training set, are fed into a large generative language model for adaptive inference decisions. APTSniffer utilizes the few-shot inference and generalization abilities of large language models by converting raw traffic data into natural language inference examples understandable by the LLM. Experimental results show that, compared to other baseline models, APTSniffer exhibits SOTA performance. It achieves F1 scores above 97\% on three APT datasets, making it practically applicable for APT traffic detection tasks.

## Script Description:

1. **a1_sam3_ok_label_distribution_pro2.py**: This corresponds to the exact sequence matching module.
2. **a2_rag2_sim.py**: This corresponds to the fuzzy sequence similarity matching module.
3. **a3_Corrs_2_ok.py**: This corresponds to the Traffic correlation graph matching module.
4. **main.py**: This is the main scheduling function, primarily responsible for generating label distribution and fine-tuning the weight matrix.
5. **main2_2_predict.py**: After generating label distribution and other information, this script calls the large language model for decision-making.

## Dataset:

The Anyrun2024 dataset is our self-collected large-scale APT traffic dataset containing actual attack traffic samples from multiple APT groups. The APT traffic data in this dataset was manually selected from the Any.run sandbox by filtering for APT-labeled samples and then manually downloading the corresponding PCAP files. We downloaded 2044 PCAP files from different APT group attack samples, covering the years 2019-2024. To ensure the accuracy of the labels, we used Suricata to detect this dataset and filtered the traffic generated by the attack IPs from the alerts. We then used Tshark to extract the traffic generated by the attack IPs to ensure it was APT attack traffic. 

The download link is as follows: https://drive.google.com/file/d/1ShVpTLPTsvGHdZ9xLT8JKKICEYAHHULg/view
